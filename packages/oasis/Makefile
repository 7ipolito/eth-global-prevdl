# ===========================================
# PrevDL Ads - Oasis Sapphire Makefile
# ===========================================
# 
# Quick commands for building, testing, and deploying
# the PrevDL Ads privacy-preserving advertising system
#
# Prerequisites:
# - Foundry installed (https://book.getfoundry.sh/getting-started/installation)
# - .env file with PRIVATE_KEY configured
#
# ===========================================

.PHONY: help install build test clean deploy-local deploy-testnet deploy-mainnet verify-testnet verify-mainnet

# Default target
help:
	@echo "========================================"
	@echo "PrevDL Ads - Oasis Sapphire Commands"
	@echo "========================================"
	@echo ""
	@echo "ğŸ”§ Setup & Build:"
	@echo "  make install          - Install dependencies"
	@echo "  make build            - Compile contracts"
	@echo "  make clean            - Clean build artifacts"
	@echo ""
	@echo "ğŸ§ª Testing:"
	@echo "  make test             - Run all tests"
	@echo "  make test-verbose     - Run tests with verbose output"
	@echo "  make test-gas         - Run tests with gas reports"
	@echo "  make coverage         - Generate test coverage report"
	@echo ""
	@echo "ğŸš€ Deployment:"
	@echo "  make deploy-local     - Deploy to local node"
	@echo "  make deploy-testnet   - Deploy to Sapphire Testnet"
	@echo "  make deploy-mainnet   - Deploy to Sapphire Mainnet"
	@echo "  make deploy-test-data - Deploy with test campaigns"
	@echo ""
	@echo "âœ… Verification:"
	@echo "  make verify-testnet   - Verify contract on testnet"
	@echo "  make verify-mainnet   - Verify contract on mainnet"
	@echo ""
	@echo "ğŸ“Š Analytics:"
	@echo "  make size             - Check contract sizes"
	@echo "  make gas-snapshot     - Create gas snapshot"
	@echo ""
	@echo "ğŸ” Inspection:"
	@echo "  make inspect          - Show contract info"
	@echo "  make abi              - Generate ABI files"
	@echo ""
	@echo "========================================"

# ===========================================
# SETUP & BUILD
# ===========================================

install:
	@echo "ğŸ“¦ Installing dependencies..."
	forge install
	@echo "âœ… Dependencies installed!"

build:
	@echo "ğŸ”¨ Building contracts..."
	forge build
	@echo "âœ… Build complete!"

clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	forge clean
	rm -rf cache out deployments/*.json
	@echo "âœ… Clean complete!"

# ===========================================
# TESTING
# ===========================================

test:
	@echo "ğŸ§ª Running tests..."
	forge test
	@echo "âœ… Tests complete!"

test-verbose:
	@echo "ğŸ§ª Running tests (verbose)..."
	forge test -vvv

test-gas:
	@echo "â›½ Running tests with gas reports..."
	forge test --gas-report

coverage:
	@echo "ğŸ“Š Generating coverage report..."
	forge coverage
	@echo "âœ… Coverage report generated!"

# ===========================================
# DEPLOYMENT
# ===========================================

deploy-local:
	@echo "ğŸš€ Deploying to local Sapphire node..."
	@echo "âš ï¸  Make sure Sapphire local node is running on http://localhost:8545"
	forge script script/Deploy.s.sol:DeployPrevDLAds \
		--rpc-url sapphire_local \
		--broadcast \
		-vvv
	@echo "âœ… Deployed to local!"

deploy-testnet:
	@echo "ğŸš€ Deploying to Sapphire Testnet..."
	@echo "ğŸ“¡ Chain: Sapphire Testnet (23295)"
	@echo "ğŸŒ RPC: https://testnet.sapphire.oasis.io"
	@if [ -z "$(PRIVATE_KEY)" ]; then \
		echo "âŒ Error: PRIVATE_KEY not set in .env"; \
		echo "ğŸ’¡ Create .env file: cp .env.example .env"; \
		echo "ğŸ’¡ Add PRIVATE_KEY=0x... to .env"; \
		exit 1; \
	fi
	forge script script/Deploy.s.sol:DeployPrevDLAds \
		--rpc-url sapphire_testnet \
		--broadcast \
		--private-key $(PRIVATE_KEY) \
		--verify \
		-vvv
	@echo "âœ… Deployed to testnet!"
	@echo "ğŸ” View on explorer: https://explorer.oasis.io/testnet/sapphire"

deploy-mainnet:
	@echo "ğŸš€ Deploying to Sapphire Mainnet..."
	@echo "âš ï¸  WARNING: This will deploy to PRODUCTION!"
	@echo "ğŸ“¡ Chain: Sapphire Mainnet (23294)"
	@echo "ğŸŒ RPC: https://sapphire.oasis.io"
	@echo ""
	@read -p "Are you sure? (yes/no): " confirm; \
	if [ "$$confirm" != "yes" ]; then \
		echo "âŒ Deployment cancelled"; \
		exit 1; \
	fi
	@if [ -z "$(PRIVATE_KEY)" ]; then \
		echo "âŒ Error: PRIVATE_KEY not set in .env"; \
		echo "ğŸ’¡ Create .env file: cp .env.example .env"; \
		echo "ğŸ’¡ Add PRIVATE_KEY=0x... to .env"; \
		exit 1; \
	fi
	forge script script/Deploy.s.sol:DeployPrevDLAds \
		--rpc-url sapphire_mainnet \
		--broadcast \
		--private-key $(PRIVATE_KEY) \
		--verify \
		-vvv
	@echo "âœ… Deployed to mainnet!"
	@echo "ğŸ” View on explorer: https://explorer.oasis.io/mainnet/sapphire"

deploy-test-data:
	@echo "ğŸ§ª Deploying with test data..."
	forge script script/Deploy.s.sol:DeployWithTestData \
		--rpc-url sapphire_testnet \
		--broadcast \
		-vvv
	@echo "âœ… Deployed with test campaigns!"

# ===========================================
# VERIFICATION
# ===========================================

verify-testnet:
	@echo "âœ… Verifying contract on Sapphire Testnet..."
	@if [ -z "$(CONTRACT_ADDRESS)" ]; then \
		echo "âŒ Error: CONTRACT_ADDRESS not provided"; \
		echo "Usage: make verify-testnet CONTRACT_ADDRESS=0x..."; \
		exit 1; \
	fi
	forge verify-contract \
		$(CONTRACT_ADDRESS) \
		src/PrevDLAds.sol:PrevDLAds \
		--chain-id 23295 \
		--verifier blockscout \
		--verifier-url https://explorer.oasis.io/testnet/sapphire/api
	@echo "âœ… Contract verified!"

verify-mainnet:
	@echo "âœ… Verifying contract on Sapphire Mainnet..."
	@if [ -z "$(CONTRACT_ADDRESS)" ]; then \
		echo "âŒ Error: CONTRACT_ADDRESS not provided"; \
		echo "Usage: make verify-mainnet CONTRACT_ADDRESS=0x..."; \
		exit 1; \
	fi
	forge verify-contract \
		$(CONTRACT_ADDRESS) \
		src/PrevDLAds.sol:PrevDLAds \
		--chain-id 23294 \
		--verifier blockscout \
		--verifier-url https://explorer.oasis.io/mainnet/sapphire/api
	@echo "âœ… Contract verified!"

# ===========================================
# ANALYTICS & INSPECTION
# ===========================================

size:
	@echo "ğŸ“ Checking contract sizes..."
	forge build --sizes

gas-snapshot:
	@echo "â›½ Creating gas snapshot..."
	forge snapshot
	@echo "âœ… Snapshot saved to .gas-snapshot"

inspect:
	@echo "ğŸ” Contract Information:"
	@echo ""
	@echo "ğŸ“ PrevDLAds.sol:"
	@forge inspect src/PrevDLAds.sol:PrevDLAds methods 2>/dev/null || echo "Build contracts first: make build"
	@echo ""
	@echo "Storage Layout:"
	@forge inspect src/PrevDLAds.sol:PrevDLAds storage-layout --pretty 2>/dev/null || echo "Build contracts first: make build"

abi:
	@echo "ğŸ“‹ Generating ABI files..."
	@mkdir -p abi
	@forge inspect src/PrevDLAds.sol:PrevDLAds abi > abi/PrevDLAds.json
	@forge inspect src/Types.sol:Types abi > abi/Types.json 2>/dev/null || true
	@echo "âœ… ABI files generated in ./abi/"

# ===========================================
# UTILITY COMMANDS
# ===========================================

format:
	@echo "ğŸ¨ Formatting code..."
	forge fmt
	@echo "âœ… Code formatted!"

lint:
	@echo "ğŸ” Linting code..."
	forge fmt --check
	@echo "âœ… Linting complete!"

update:
	@echo "â¬†ï¸  Updating dependencies..."
	forge update
	@echo "âœ… Dependencies updated!"

# ===========================================
# DEVELOPMENT WORKFLOW
# ===========================================

dev: clean install build test
	@echo "âœ… Development build complete!"

# Full CI/CD pipeline
ci: clean install build test coverage gas-snapshot
	@echo "âœ… CI pipeline complete!"

# Quick iteration cycle
quick: build test
	@echo "âœ… Quick build and test complete!"

# ===========================================
# INFORMATION
# ===========================================

info:
	@echo "========================================"
	@echo "PrevDL Ads - Project Information"
	@echo "========================================"
	@echo ""
	@echo "ğŸ“‚ Project Structure:"
	@echo "  src/          - Smart contracts"
	@echo "  test/         - Test files"
	@echo "  script/       - Deployment scripts"
	@echo "  lib/          - Dependencies"
	@echo ""
	@echo "ğŸ”— Oasis Sapphire Networks:"
	@echo "  Testnet:  Chain ID 23295"
	@echo "  Mainnet:  Chain ID 23294"
	@echo ""
	@echo "ğŸ“š Resources:"
	@echo "  Docs:     https://docs.oasis.io/build/sapphire/"
	@echo "  Explorer: https://explorer.oasis.io/"
	@echo "  Faucet:   https://faucet.testnet.oasis.io/"
	@echo ""
	@echo "ğŸ” Privacy Features:"
	@echo "  âœ“ Encrypted user profiles"
	@echo "  âœ“ Private ad matching"
	@echo "  âœ“ Confidential computations (TEE)"
	@echo "  âœ“ Privacy-preserving analytics"
	@echo ""
	@echo "========================================"

# ===========================================
# ENVIRONMENT CHECK
# ===========================================

check-env:
	@echo "ğŸ” Checking environment..."
	@if [ ! -f .env ]; then \
		echo "âš ï¸  Warning: .env file not found"; \
		echo "ğŸ’¡ Copy .env.example to .env and configure"; \
	else \
		echo "âœ… .env file found"; \
	fi
	@if [ -z "$(PRIVATE_KEY)" ]; then \
		echo "âš ï¸  Warning: PRIVATE_KEY not set"; \
	else \
		echo "âœ… PRIVATE_KEY configured"; \
	fi
	@which forge > /dev/null || (echo "âŒ Foundry not installed!" && exit 1)
	@echo "âœ… Foundry installed: $$(forge --version | head -n1)"
	@echo "âœ… Environment check complete!"

# Load .env if it exists
-include .env
export
